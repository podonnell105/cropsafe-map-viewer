<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rail Analysis Map</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
            margin-bottom: 20px;
        }
        .file-upload-container {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .file-upload-container.dragover {
            background-color: #e9ecef;
            border-color: #0d6efd;
        }
        .upload-preview {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .address-list {
            list-style: none;
            padding: 0;
        }
        .address-list li {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .address-list li:last-child {
            border-bottom: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Rail Analysis Map</h1>
        
        <!-- Map Container -->
        <div id="map"></div>
        
        <!-- File Upload Section -->
        <div class="file-upload-container" id="drop-zone">
            <h5>Upload Address List</h5>
            <p class="text-muted">Drag and drop a CSV file or click to browse</p>
            <input type="file" id="file-input" accept=".csv" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                Choose File
            </button>
            <div id="file-preview" class="upload-preview" style="display: none;">
                <h6>Uploaded Addresses:</h6>
                <ul class="address-list" id="address-preview"></ul>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // FRA MainLine MapServer REST endpoint
        const FRA_BASE_URL = "https://fragis.fra.dot.gov/arcgis/rest/services/FRA/MainLine/MapServer/0/query";
        
        // Initialize map
        const map = L.map('map').setView([41.8781, -93.0977], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Add rail line layer
        let railLayer = null;
        // Add address marker layer
        let addressLayer = null;

        // Store uploaded addresses
        let uploadedAddresses = [];

        // File upload handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        const addressPreview = document.getElementById('address-preview');

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (file.type !== 'text/csv') {
                alert('Please upload a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                processCSV(text);
            };
            reader.readAsText(file);
        }

        function processCSV(csvText) {
            const lines = csvText.split('\n');
            uploadedAddresses = [];
            addressPreview.innerHTML = '';

            // Find the address, coordinates, and state column indices
            const header = lines[0].split(',');
            let addressCol = header.findIndex(h => h.trim().toLowerCase() === 'address');
            let coordCol = header.findIndex(h => h.trim().toLowerCase() === 'coordinates');
            let stateCol = header.findIndex(h => h.trim().toLowerCase() === 'state');
            if (addressCol === -1) addressCol = 0; // fallback
            if (coordCol === -1) coordCol = 1; // fallback
            if (stateCol === -1) stateCol = 2; // fallback

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // Handle quoted CSV fields
                    const cols = parseCSVLine(line);
                    const address = cols[addressCol]?.trim().replace(/^"|"$/g, '');
                    const coord = cols[coordCol]?.trim().replace(/^"|"$/g, '');
                    const state = cols[stateCol]?.trim().replace(/^"|"$/g, '');
                    if (address && coord && state) {
                        uploadedAddresses.push({ address, coord, state });
                        const li = document.createElement('li');
                        li.textContent = `${address} (${coord}) [${state}]`;
                        addressPreview.appendChild(li);
                    }
                }
            }

            filePreview.style.display = 'block';
            if (uploadedAddresses.length > 0) {
                plotAddressesAndRail();
            }
        }

        // Helper to parse a CSV line with quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // State abbreviation to full name mapping
        const STATE_ABBR_TO_NAME = {
            AL: 'Alabama', AK: 'Alaska', AZ: 'Arizona', AR: 'Arkansas', CA: 'California', CO: 'Colorado', CT: 'Connecticut', DE: 'Delaware', FL: 'Florida', GA: 'Georgia',
            HI: 'Hawaii', ID: 'Idaho', IL: 'Illinois', IN: 'Indiana', IA: 'Iowa', KS: 'Kansas', KY: 'Kentucky', LA: 'Louisiana', ME: 'Maine', MD: 'Maryland',
            MA: 'Massachusetts', MI: 'Michigan', MN: 'Minnesota', MS: 'Mississippi', MO: 'Missouri', MT: 'Montana', NE: 'Nebraska', NV: 'Nevada', NH: 'New Hampshire',
            NJ: 'New Jersey', NM: 'New Mexico', NY: 'New York', NC: 'North Carolina', ND: 'North Dakota', OH: 'Ohio', OK: 'Oklahoma', OR: 'Oregon', PA: 'Pennsylvania',
            RI: 'Rhode Island', SC: 'South Carolina', SD: 'South Dakota', TN: 'Tennessee', TX: 'Texas', UT: 'Utah', VT: 'Vermont', VA: 'Virginia', WA: 'Washington',
            WV: 'West Virginia', WI: 'Wisconsin', WY: 'Wyoming'
        };

        // Plot pins using coordinates, then show rail lines for the relevant state(s)
        async function plotAddressesAndRail() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            // Remove previous address markers
            if (addressLayer) {
                map.removeLayer(addressLayer);
            }
            addressLayer = L.layerGroup();

            // Plot each address using coordinates as green dots
            const latlngs = [];
            for (let entry of uploadedAddresses) {
                let coordStr = entry.coord.replace(/[()]/g, '').replace(/"/g, '').trim();
                let parts = coordStr.split(/[ ,]+/).filter(Boolean).map(Number);
                if (parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    const lat = parts[0];
                    const lon = parts[1];
                    latlngs.push([lat, lon]);
                    L.circleMarker([lat, lon], {
                        radius: 4,
                        color: '#28a745',
                        fillColor: '#28a745',
                        fillOpacity: 0.75,
                        weight: 1
                    }).addTo(addressLayer).bindPopup(`<strong>${entry.address}</strong><br><small>${lat}, ${lon}</small><br><small>State: ${entry.state}</small>`);
                }
            }
            addressLayer.addTo(map);
            if (latlngs.length > 0) {
                const bounds = L.latLngBounds(latlngs);
                map.fitBounds(bounds);
            }

            // Determine unique states from uploaded addresses, map to full names
            const states = Array.from(new Set(uploadedAddresses.map(e => e.state))).filter(Boolean);
            const stateNames = states.map(s => STATE_ABBR_TO_NAME[s.toUpperCase()] || s);
            let stateWhere = '';
            if (stateNames.length === 1) {
                stateWhere = ` AND STATE = '${stateNames[0]}'`;
            } else if (stateNames.length > 1) {
                stateWhere = ` AND STATE IN (${stateNames.map(s => `'${s}'`).join(',')})`;
            }

            // Fetch and show rail lines for the relevant state(s)
            try {
                const params = new URLSearchParams({
                    'outFields': '*',
                    'f': 'geojson',
                    'where': `RROWNER1 IN ('BNSF', 'UP', 'NS', 'CSXT', 'KCS', 'CN', 'CPRS')${stateWhere}`
                });
                const response = await fetch(`${FRA_BASE_URL}?${params}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (railLayer) map.removeLayer(railLayer);
                railLayer = L.geoJSON(data, {
                    style: { color: '#2c3e50', weight: 2, opacity: 0.8 },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            const popupContent = `
                                <strong>Railroad:</strong> ${feature.properties.RROWNER1}<br>
                                <strong>Track Type:</strong> ${feature.properties.TRACKTYPE || 'N/A'}<br>
                                <strong>Track Status:</strong> ${feature.properties.TRKSTATUS || 'N/A'}
                            `;
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(map);
            } catch (error) {
                alert('Error loading rail data. Please try again later.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
    </script>
</body>
</html> 